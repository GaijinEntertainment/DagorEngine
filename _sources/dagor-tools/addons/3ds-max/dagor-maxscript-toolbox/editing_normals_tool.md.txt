# Dagor Editing Normals Tool

## Installation

[Install the script](installation.md) following the provided instructions.

```{admonition} 3ds Max Version Requirement
:class: warning

This script requires **3ds Max 2023 or later**.
```

## Overview

The Editing Normals Tool provides comprehensive functionality for generating and
transferring vegetation normals using all widely recognized methods available at
the time of publication. It supports:

- **Puffiness**, similar to the technique used in SpeedTree.
- **Polysurface Method**, as demonstrated by Guerrilla Games' Gilbert Sanders
  during the 2018 GDC session on Horizon Zero Dawn.
- **Classic Normal Transfer**, via the Noors Normal Thief approach, which
  transfers normals from a parent object.

Example of the tool's output:

```{eval-rst}

.. only:: html

   .. video:: _images/editing_normals_00.webm
      :width: 90%

.. only:: latex

   `Download video (WEBM) <https://github.com/GaijinEntertainment/DagorEngine/blob/main/_docs/source/dagor-tools/addons/3ds-max/dagor-maxscript-toolbox/_images/editing_normals_00.webm>`_

```

## Accessing Editing Normals Tool

1. Navigate to **Gaijin Tools** {cnum}`1` **> Dagor Editing Normals Tool...**
   {cnum}`2`. This will open the main window of the Dagor Editing Normals Tool.

2. To verify the version {cnum}`3` of the script, go to **Gaijin
   Tools** {cnum}`1` **> About**. The **About** window will display the
   current version. It's important to check this regularly to ensure your script
   is up to date.

   ```{eval-rst}
   .. image:: _images/editing_normals_01.png
      :alt: Editing Normals Tool
      :width: 50em
      :align: center
   ```

   ```{admonition} Plugin Version Requirement
   :class: warning

   Requires plugin version **1.6 or higher**.
   ```

## Using Editing Normals Tool

To begin, open the tool panel by navigating to **Gaijin Tools > Dagor Editing
Normals Tool**.

Download the following test scene:
{download}`tree_example.max <_examples/tree_example.zip>`.

```{admonition} 3ds Max Version Requirement
:class: warning

This scene requires **3ds Max 2024 or later**.
```

### Interface Overview

The Editing Normals Tool interface is divided into three main sections:
Puffiness Settings, Polysurface Settings, and Classic Normals Thief Settings,
with a General Settings block that affects all three sections.

```{eval-rst}
.. image:: _images/editing_normals_02.png
   :alt: Editing Normals Tool
   :width: 70em
   :align: center
```

- **From Ground Center Offset** {cnum}`1`: adjusts the elevation of the
  Puffiness build point from the ground to the center of the build.
- **Start Puffiness!** {cnum}`2`: initiates the Puffiness generation process.
- **Strength %** {cnum}`10`: controls the blending ratio between the new and
  existing normals on the object. This is crucial when you only need to
  partially replace the normals' weight. A typical range is 70% to 90%.
- **Display Normals Length** {cnum}`11`: determines the duration that normals
  are displayed in the Viewport.

### Working with Puffiness

To see how Puffiness works, set parameter **Strength %** {cnum}`10` to `100` and
parameter **Display Normals Length** {cnum}`11` to `100` for clear visibility.
Note that the normal length is dependent on the scene’s scale and units. Select
the palm tree in the test scene (you can also process multiple objects or LODs
at once). Press the **Start Puffiness!** {cnum}`2` button to generate the
normals:

```{eval-rst}
.. image:: _images/editing_normals_03.png
   :alt: Editing Normals Tool
   :width: 50em
   :align: center
```

Initially, the center aligns with the tree’s base, near the Pivot. If needed,
adjust the center by setting **From Ground Center Offset** {cnum}`1` to `2500`.
Remove the **Edit Normals** modifier generated by the script before re-running
the process. After pressing the **Start Puffiness!** {cnum}`2` button again, you
should see the result:

```{eval-rst}
.. image:: _images/editing_normals_04.png
   :alt: Editing Normals Tool
   :width: 50em
   :align: center
```

As you can see, everything is much better with the crown. With the crown
adjusted, set the **Strength %** {cnum}`10` to 80%, remove the **Edit Normals**
modifier again, and run the process:

```{eval-rst}
.. image:: _images/editing_normals_05.png
   :alt: Editing Normals Tool
   :width: 50em
   :align: center
```

The result shows improved lighting on the large palm leaves, though issues may
still exist with the root system. To address this, you may need to edit the
normals on the roots separately. Some tree bark normals might remain unedited,
shown as blue. The **Keep Normals on Material Name** {cnum}`12` parameter is
vital here, as it allows you to specify which materials' normals will be
processed.

```{eval-rst}
.. image:: _images/editing_normals_06.png
   :alt: Editing Normals Tool
   :width: 50em
   :align: center
```

For example, if the bark is named "bark", ensure that `bark` is listed in
{cnum}`12`. This field supports RegExp, enabling precise control over which
materials are included or excluded from processing. After adjusting the
expression, set the **From Ground Center Offset** {cnum}`1` parameter to zero.
After all, the center of illumination of the root beam should be just somewhere
at zero. At the Pivot point of the object. Set the parameter of normal transfer
strength {cnum}`10` to 80% and rerun the Puffiness generation:

```{eval-rst}
.. image:: _images/editing_normals_07.png
   :alt: Editing Normals Tool
   :width: 50em
   :align: center
```

### Polysurface Settings

The **Polysurface Settings** block provides advanced tools for generating and
transferring normals, originally used in the Horizon Zero Dawn project.

```{seealso}
More details about the method can be found in the video
[Between Tech and Art: The
Vegetation of Horizon Zero Dawn](https://www.youtube.com/watch?v=wavnKZNSYqU).
```

To apply similar lighting effects to your tree, select the tree without the
**Edit Normals** modifier and configure the **Polysurface Settings** and
**General Group** as shown below. Ensure that "bark" is excluded from normal
adjustments:

```{eval-rst}
.. image:: _images/editing_normals_08.png
   :alt: Editing Normals Tool
   :width: 70em
   :align: center
```

After applying, you should see a result similar to this:

```{eval-rst}
.. image:: _images/editing_normals_09.png
   :alt: Editing Normals Tool
   :width: 50em
   :align: center
```

You can remove the Polysurface after generation using **Delete PSurface after
Transfer** {cnum}`6` checkbox.

```{note}
All Polysurface parameters are sensitive to the scene size and object scale. If
values are set too high, Polysurface may not generate; too low, and it could
generate with excessive triangles, causing processing issues in 3ds Max.
```

Adjust these settings carefully:

- **Polysurface Size** {cnum}`3`: controls surface smoothness. A larger value
  results in a smoother surface, while a smaller value creates more detailed but
  less smooth surfaces.
- **Polysurface Tension** {cnum}`4`: sets the surface tension. A value of `1.0`
  creates a maximally bulged surface, and `0.0` creates a tight surface.
  Typically, `0.5` is optimal, though this may vary based on the object type
  (e.g., higher for conifers, lower for palm trees).
- **Polysurface Accuracy** {cnum}`5`: defines the step size for generating
  surface triangles. Smaller steps yield more precise surfaces but increase the
  triangle count exponentially. Usually 20 to 30 thousand triangles are enough
  to get an excellent result of Polysurface generation. Carefully reduce the
  value. Reducing the value by 2 times you increase the number of resulting
  triangles from 4 to 9 times.

### Classic Normals Thief Method

The Normals Thief method, dating back to 2008, allows manual creation and
projection of normals. Select the source object with the **Source Object**
{cnum}`8` button, and project normals onto the target object using the **Steal
!** {cnum}`9`.

```{seealso}
For more information, see
[Noors Normal Thief](http://www.scriptspot.com/3ds-max/scripts/noors-normal-thief).
```

In the General Block, you can adjust the normal transfer strength {cnum}`10`
(default: 50%). Setting this to 100% replicates the classic Normals Thief
behavior. You can also clear the material exclusion mask for full normal
transfer, mimicking the original tool's functionality.

- **Progress bar** {cnum}`13`: progress bar.
- **Open Local Documentation** {cnum}`14`: links to this documentation.
- **Contact with Developer** {cnum}`15`: provides contact information for the
  developer if assistance is needed.

